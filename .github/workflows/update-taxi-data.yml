name: Update Taxi Data

on:
  workflow_dispatch: # Manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Call LTA Taxi API and build full dataset
        env:
          ACCOUNT_KEY: ${{ secrets.ACCOUNT_KEY }}
        run: |
          set -e
          
          # Initial call to create the base file
          curl -H "AccountKey: $ACCOUNT_KEY" -H "Accept: application/json" \
            "https://datamall2.mytransport.sg/ltaodataservice/Taxi-Availability" > all_data.json

          # Ensure the base file is valid before starting
          if ! jq -e \'.value\' all_data.json > /dev/null; then
            echo "Initial API call failed or returned invalid data."
            exit 1
          fi

          SKIP=0
          # Loop indefinitely until we break it from the inside
          while true; do
            PREV_TOTAL=$(jq \'.value | length\' all_data.json)
            
            SKIP=$((SKIP + 500))
            echo "Fetching next page, skipping $SKIP records. Current unique total: $PREV_TOTAL"

            # Fetch the next page
            curl -sf -H "AccountKey: $ACCOUNT_KEY" -H "Accept: application/json" \
              "https://datamall2.mytransport.sg/ltaodataservice/Taxi-Availability?$skip=${SKIP}" > next_page.json

            # Verify that the new page has a valid \'value\' array. If not, we are done.
            if ! jq -e \'.value | length > 0\' next_page.json > /dev/null; then
              echo "Final page is empty or invalid. Stopping."
              break
            fi

            # Merge the new page\'s values, remove duplicates, and check the new total
            jq \'.value |= (. + input.value) | .value |= unique\' all_data.json next_page.json > temp_merged.json
            mv temp_merged.json all_data.json
            
            NEW_TOTAL=$(jq \'.value | length\' all_data.json)

            # If the total number of unique taxis has not increased, we are done.
            if [ "$NEW_TOTAL" -eq "$PREV_TOTAL" ]; then
              echo "No new unique taxis found. Loop detected and stopped."
              break
            fi
          done

          echo "Finished fetching all data. Overwriting taxi-data.json."
          mv all_data.json taxi-data.json

      - name: Commit and push data file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add taxi-data.json
          git diff --cached --quiet || git commit -m "Update taxi data (full dataset)"
          git push

