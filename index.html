<!DOCTYPE html>
<html>
<head>

    <title>Live Taxi Map</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- Leaflet and other libraries -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css"/>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-locatecontrol/0.66.2/L.Control.Locate.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-locatecontrol/0.66.2/L.Control.Locate.min.css"/>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        #map_845a0ec8331ce3e14fbac42f2fe52798 {
            position: relative;
            width: 100.0%;
            height: 100.0%;
            left: 0.0%;
            top: 0.0%;
        }
        .leaflet-container { font-size: 1rem; }

        /* Redesigned Info Panels */
        .info-panel {
            position: fixed;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(5px);
            display: block;
            transition: all 0.3s ease;
        }
        #taxi-count {
            top: 20px;
            left: 50px;
        }
        #timestamp {
            top: 80px; 
            left: 50px;
        }
    </style>

    <script>
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>

</head>
<body>
 
    <div id="taxi-count" class="info-panel">
        Total taxis: 0
    </div>
    <div id="timestamp" class="info-panel">
        Last updated: 
    </div>

    <div class="folium-map" id="map_845a0ec8331ce3e14fbac42f2fe52798" ></div>

<script>
  // Determine initial zoom level based on screen width
  var initialZoom = 12; // Default zoom for larger screens
  if (window.innerWidth < 768) {
    initialZoom = 10; // Zoom out for smaller screens
  }

  var map_845a0ec8331ce3e14fbac42f2fe52798 = L.map(
     "map_845a0ec8331ce3e14fbac42f2fe52798",
     {
         center: [1.3521, 103.8198],
         crs: L.CRS.EPSG3857,
         zoom: initialZoom,
         preferCanvas: false,
     }
  );

  var tile_layer_42c9db8e347aa656d59682a82154c117 = L.tileLayer(
      "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
          "minZoom": 0, "maxZoom": 19, "maxNativeZoom": 19, "noWrap": false, 
          "attribution": '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | Contains information from <b>Taxi Availability</b>, provided by the Land Transport Authority (LTA) via DataMall, and is made available under the terms of the <a href="https://datamall.lta.gov.sg/content/datamall/en/SingaporeOpenDataLicence.html" target="_blank">Singapore Open Data Licence version 1.0</a>',
          "subdomains": "abc", "detectRetina": false, "tms": false, "opacity": 1,
      }
  );
  tile_layer_42c9db8e347aa656d59682a82154c117.addTo(map_845a0ec8331ce3e14fbac42f2fe52798);

  L.control.locate({}).addTo(map_845a0ec8331ce3e14fbac42f2fe52798);
  L.control.scale({ position: 'bottomright' }).addTo(map_845a0ec8331ce3e14fbac42f2fe52798);

  const taxiLayer = L.layerGroup().addTo(map_845a0ec8331ce3e14fbac42f2fe52798);

  const taxiDataUrl = 'https://raw.githubusercontent.com/Wen-Xi-Goh/taxi-locations/main/taxi-data.json';

  async function refreshTaxiMarkers() {
      try {
          const res = await fetch(`${taxiDataUrl}?v=${new Date().getTime()}`, { cache: 'no-cache' });
          const data = await res.json();
          taxiLayer.clearLayers();

          const taxiCount = data.value.length;
          const taxiCountEl = document.getElementById('taxi-count');
          taxiCountEl.innerText = 'Total taxis: ' + taxiCount;

          for (const taxi of data.value) {
              L.circleMarker([taxi.Latitude, taxi.Longitude], {
                  radius: 3,
                  color: '#0000FF',
                  fillOpacity: 0.7
              }).addTo(taxiLayer);
          }

          // Use the timestamp from the data file
          const timestampEl = document.getElementById('timestamp');
          if (data.last_updated) {
              const updateTimestamp = new Date(data.last_updated);
              timestampEl.innerText = 'Last updated: ' + updateTimestamp.toLocaleString();
          } else {
              timestampEl.innerText = 'Last updated: (live)'; // Fallback for older data
          }

      } catch (err) {
          console.error("Taxi data refresh failed:", err);
      }
  }

  setInterval(refreshTaxiMarkers, 60000);
  refreshTaxiMarkers();

  L.easyButton('fa-home', function(){
      map_845a0ec8331ce3e14fbac42f2fe52798.flyTo([1.3521, 103.8198], 12);
  }, 'Zoom to Home').addTo(map_845a0ec8331ce3e14fbac42f2fe52798);
</script>

</body>
</html>
